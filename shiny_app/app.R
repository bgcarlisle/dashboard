library(plotly)
library(shiny)
library(shinydashboard)
library(tidyverse)
library(ggvis)
library(ggplot2)
library(shinythemes)
library(shinyBS)
library(shinyjs)
library(DT)
library(R.utils)

## Load data
rm_data <- read_csv(
    "data/2021-01-31_pop_with_oa_trn_sciscore.csv",
    col_types="ccdddcccccdcccdllllllcddccccDlccccccccccccccccccccdddddddddddddddddddddddd"
    ## Need to specify column types here because read_csv
    ## only looks at the first few rows to determine type
    ## automatically, and if they're all empty, assumes
    ## that they're logical. This is a problem when it
    ## gets right to the end of the TRN columns and finds
    ## an NCT number there and kicks back a warning.

    ## NOTE: IF WE EVER ADD MORE COLUMNS, THE COLUMN TYPE
    ## SPECIFICATION WILL NEED TO BE UPDATED MANUALLY
)

odoc_data <- read_csv(
    "data/2021-01-26_pp-dataset-oa-od.csv"
    ## This one is for the open data/open code variables. We'll
    ## harmonize this all into a single data file at some point.
    ## We promise.
)

## Load functions
source("ui_elements.R")
source("start_page_plots.R")
source("all_umc_plots.R")

## Load pages
source("start_page.R")
source("all_umcs_page.R")
source("methods_page.R")
source("datasets_page.R")
source("about_rm.R")

## Define UI
ui <- tagList(
    tags$head(tags$script(type="text/javascript", src = "code.js")),
    navbarPage(
        "Responsible Metrics Dashboard", theme = shinytheme("flatly"), id = "navbarTabs",
        start_page,
        all_umcs_page,
        methods_page,
        datasets_page,
        about_rm_page,
        tags$head
        (
            tags$script
            ('
                        var width = 0;
                        $(document).on("shiny:connected", function(e) {
                          width = window.innerWidth;
                          Shiny.onInputChange("width", width);
                        });
                        '
            )
        )
    )
)

## Define server function
server <- function (input, output, session) {

    ## Define button actions

    observeEvent(
        input$buttonAllUMCs, {
            updateTabsetPanel(
                session, "navbarTabs",
                selected = "tabAllUMCs"
            )
        }
    )
    
    observeEvent(
        input$buttonMethods, {
            updateTabsetPanel(
                session, "navbarTabs",
                selected = "tabMethods"
            )
        }
    )

    observeEvent(
        input$buttonDatasets, {
            updateTabsetPanel(
                session, "navbarTabs",
                selected = "tabDatasets"
            )
        }
    )

    ## Dynamically determine column width of for displayed metrics
    ## at program start; four columns if resolution large enough,
    ## otherwise two columns.

    output$robustness_metrics <- renderUI({

        req(input$width)

        if (input$width < 1400) {
            col_width <- 6
            alignment <- "left"
        } else {
            col_width <- 3
            alignment <- "right"
        }

        all_numer_rando <- rm_data %>%
            filter(
                is_animal == 1,
                ! is.na(sciscore),
                type == "Article"
            ) %>%
            select(randomization) %>%
            sum(na.rm=TRUE)

        all_numer_blinded <- rm_data %>%
            filter(
                is_animal == 1,
                ! is.na(sciscore),
                type == "Article"
            ) %>%
            select(blinding) %>%
            sum(na.rm=TRUE)

        all_numer_power <- rm_data %>%
            filter(
                is_animal == 1,
                ! is.na(sciscore),
                type == "Article"
            ) %>%
            select(power) %>%
            sum(na.rm=TRUE)

        all_numer_iacuc <- rm_data %>%
            filter(
                is_animal == 1,
                ! is.na(sciscore),
                type == "Article"
            ) %>%
            select(iacuc) %>%
            sum(na.rm=TRUE)

        all_denom_animal_sciscore <- rm_data %>%
            filter(
                is_animal == 1,
                ! is.na(sciscore),
                type == "Article"
            ) %>%
            nrow()

        all_percent_randomized <- paste0(round(100*all_numer_rando/all_denom_animal_sciscore), "%")
        all_percent_blinded <- paste0(round(100*all_numer_blinded/all_denom_animal_sciscore), "%")
        all_percent_power <- paste0(round(100*all_numer_power/all_denom_animal_sciscore), "%")
        all_percent_iacuc <- paste0(round(100*all_numer_iacuc/all_denom_animal_sciscore), "%")

        wellPanel(
            style = "padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Robustness of animal studies"), align = "left"),
            fluidRow(
                column(
                    col_width,
                    metric_box(
                        title = "Randomization",
                        value = all_percent_randomized,
                        value_text = "of animal studies report randomization",
                        plot = plotlyOutput('plot_randomization', height="300px"),
                        info_id = "infoRandomization",
                        info_title = "Randomization",
                        info_text = randomization_tooltip
                    )
                ),
                column(
                    col_width,
                    metric_box(
                        title = "Blinding",
                        value = all_percent_blinded,
                        value_text = "of animal studies report blinding",
                        plot = plotlyOutput('plot_blinding', height="300px"),
                        info_id = "infoBlinding",
                        info_title = "Blinding",
                        info_text = blinding_tooltip
                    )
                ),
                column(
                    col_width,
                    metric_box(
                        title = "Power calculation",
                        value = all_percent_power,
                        value_text = "of animal studies report a power calculation",
                        plot = plotlyOutput('plot_power', height="300px"),
                        info_id = "infoPower",
                        info_title = "Power",
                        info_text = power_tooltip
                    )
                ),
                column(
                    col_width,
                    metric_box(
                        title = "IACUC statement",
                        value = all_percent_iacuc,
                        value_text = "of animal studies report an IACUC statement",
                        plot = plotlyOutput('plot_iacuc', height="300px"),
                        info_id = "infoIACUC",
                        info_title = "IACUC",
                        info_text = iacuc_tooltip
                    )
                )
            )
        )        
        
    })

    output$clinicaltrials_metrics <- renderUI({

        req(input$width)

        if (input$width < 1400) {
            col_width <- 6
            alignment <- "left"
        } else {
            col_width <- 3
            alignment <- "right"
        }

        all_numer_trn <- rm_data %>%
            filter(
                is_human_ct == 1,
                ! is.na(abs_trn_1)
            ) %>%
            nrow()
        
        all_denom_trn <- rm_data %>%
            filter(is_human_ct == 1) %>%
            nrow()

        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Clinical Trials"), align = "left"),
            fluidRow(
                column(
                    col_width,
                    metric_box(
                        title = "Trial Registry Number Reporting",
                        value = paste0(round(100*all_numer_trn/all_denom_trn), "%"),
                        value_text = "of clinical trial publications reported a TRN in the abstract",
                        plot = plotlyOutput('plot_clinicaltrials_trn', height="300px"),
                        info_id = "infoTRN",
                        info_title = "Trial Registry Number Reporting",
                        info_text = trn_tooltip
                    )
                )
                
            )

        )

        
    })

    output$openscience_metrics <- renderUI({

        req(input$width)

        if (input$width < 1400) {
            col_width <- 6
            alignment <- "left"
        } else {
            col_width <- 3
            alignment <- "right"
        }

        ## Value for Open Access

        all_numer_oa <- rm_data %>%
            filter(
                color == "gold" | color == "green" | color == "hybrid"
                
            ) %>%
            nrow()

        all_denom_oa <- rm_data %>%
            filter(
                ! is.na(color)
                
            ) %>%
            nrow()

        ## Value for Open Data

        all_denom_od <- odoc_data %>%
            filter(
                ! is.na (is_open_data),
                language == "English"
            ) %>%
            nrow()

        all_numer_od <- odoc_data %>%
            filter(
                is_open_data,
                language == "English"
            ) %>%
            nrow()

        ## Value for Open Code

        all_denom_oc <- odoc_data %>%
            filter(
                ! is.na (is_open_code),
                language == "English"
            ) %>%
            nrow()

        all_numer_oc <- odoc_data %>%
            filter(
                is_open_code,
                language == "English"
            ) %>%
            nrow()
        
        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Open Science"), align = "left"),
            fluidRow(
                column(
                    col_width,
                    metric_box(
                        title = "Open Access",
                        value = paste0(round(100*all_numer_oa/all_denom_oa), "%"),
                        value_text = "of publications were Open Access",
                        plot = plotlyOutput('plot_opensci_oa', height="300px"),
                        info_id = "infoOpenAccess",
                        info_title = "Open Access",
                        info_text = openaccess_tooltip
                    )
                ),
                column(
                    col_width,
                    metric_box(
                        title = "Open Data",
                        value = paste0(round(100*all_numer_od/all_denom_od), "%"),
                        value_text = "of analyzable publications reported Open Data",
                        plot = plotlyOutput('plot_opensci_od', height="300px"),
                        info_id = "infoOpenData",
                        info_title = "Open Data",
                        info_text = opendata_tooltip
                    )
                ),
                column(
                    col_width,
                    metric_box(
                        title = "Open Code",
                        value = paste0(round(100*all_numer_oc/all_denom_oc), "%"),
                        value_text = "of analyzable publications reported Open Code",
                        plot = plotlyOutput('plot_opensci_oc', height="300px"),
                        info_id = "infoOpenCode",
                        info_title = "Open Code",
                        info_text = opencode_tooltip
                    )
                )
            )
        )

    })

    output$allumc_openaccess <- renderUI({
        
        all_numer_oa <- rm_data %>%
            filter(
                color == "gold" | color == "green" | color == "hybrid"
            ) %>%
            nrow()

        all_denom_oa <- rm_data %>%
            filter(
                ! is.na(color)
                
            ) %>%
            nrow()

        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Open Science"), align = "left"),
            fluidRow(
                column(
                    12,
                    metric_box(
                        title = "Open Access",
                        value = paste0(round(100*all_numer_oa/all_denom_oa), "%"),
                        value_text = "of publications were Open Access",
                        plot = plotlyOutput('plot_allumc_openaccess', height="300px"),
                        info_id = "infoALLUMCOpenAccess",
                        info_title = "Open Access (All UMCs)",
                        info_text = allumc_openaccess_tooltip
                    )
                )
            )
        )
        
    })

    output$allumc_opendata <- renderUI({

        ## Value for Open Data

        all_denom_od <- odoc_data %>%
            filter(
                ! is.na (is_open_data),
                language == "English"
            ) %>%
            nrow()

        all_numer_od <- odoc_data %>%
            filter(
                is_open_data,
                language == "English"
            ) %>%
            nrow()

        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Open Data"), align = "left"),
            fluidRow(
                column(
                    12,
                    metric_box(
                        title = "Open Data",
                        value = paste0(round(100*all_numer_od/all_denom_od), "%"),
                        value_text = "of publications were Open Data",
                        plot = plotlyOutput('plot_allumc_opendata', height="300px"),
                        info_id = "infoALLUMCOpenData",
                        info_title = "Open Data (All UMCs)",
                        info_text = allumc_opendata_tooltip
                    )
                )
            )
        )
        
    })

    output$allumc_opencode <- renderUI({

        ## Value for Open Code

        all_denom_oc <- odoc_data %>%
            filter(
                ! is.na (is_open_code),
                language == "English"
            ) %>%
            nrow()

        all_numer_oc <- odoc_data %>%
            filter(
                is_open_code,
                language == "English"
            ) %>%
            nrow()

        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Open Code"), align = "left"),
            fluidRow(
                column(
                    12,
                    metric_box(
                        title = "Open Code",
                        value = paste0(round(100*all_numer_oc/all_denom_oc), "%"),
                        value_text = "of publications were Open Code",
                        plot = plotlyOutput('plot_allumc_opencode', height="300px"),
                        info_id = "infoALLUMCOpenCode",
                        info_title = "Open Code (All UMCs)",
                        info_text = allumc_opencode_tooltip
                    )
                )
            )
        )
        
    })

    output$allumc_clinicaltrials_trn <- renderUI({

        ## Value for TRN
        
        all_numer_trn <- rm_data %>%
            filter(
                is_human_ct == 1,
                ! is.na(abs_trn_1)
            ) %>%
            nrow()
        
        all_denom_trn <- rm_data %>%
            filter(is_human_ct == 1) %>%
            nrow()

        wellPanel(
            style="padding-top: 0px; padding-bottom: 0px;",
            h2(strong("Trial Registry Number Reporting"), align = "left"),
            fluidRow(
                column(
                    12,
                    metric_box(
                        title = "Trial Registry Number Reporting",
                        value = paste0(round(100*all_numer_trn/all_denom_trn), "%"),
                        value_text = "of clinical trial publications reported a TRN in the abstract",
                        plot = plotlyOutput('plot_allumc_clinicaltrials_trn', height="300px"),
                        info_id = "infoALLUMCTRN",
                        info_title = "TRN reporting (All UMCs)",
                        info_text = allumc_clinicaltrials_trn_tooltip
                    )
                )
            )
        )
        
    })

    color_palette <- c("#B6B6B6", "#879C9D", "#F1BA50", "#AA493A",
                     "#303A3E", "#007265", "#634587", "#000000",   #363457 #533A71 #011638 #634587
                     "#DCE3E5")

    color_palette_bars <- c("#AA1C7D", "#879C9D", "#F1BA50", "#AA493A", "#303A3E", "#007265", "#634587", "#AA1C7D", "#879C9D", "#F1BA50", "#AA493A", "#303A3E", "#007265", "#634587")

    ## Start page plots ##
    
    ## Open Access plot
    output$plot_opensci_oa <- renderPlotly({
        return (plot_opensci_oa(rm_data, input$selectUMC, color_palette))
    })
    
    ## Open Data plot
    output$plot_opensci_od <- renderPlotly({
        return (plot_opensci_od(odoc_data, input$selectUMC, color_palette))
    })
    
    ## Open Code plot
    output$plot_opensci_oc <- renderPlotly({
        return (plot_opensci_oc(odoc_data, input$selectUMC, color_palette))
    })
    
    ## TRN plot
    output$plot_clinicaltrials_trn <- renderPlotly({
        return (plot_clinicaltrials_trn(rm_data, input$selectUMC, color_palette))
    })

    ## Robustness plot
    output$plot_randomization <- renderPlotly({
        return (plot_randomization(rm_data, input$selectUMC, color_palette))
    })

    ## Blinding plot
    output$plot_blinding <- renderPlotly({
        return(plot_blinding(rm_data, input$selectUMC, color_palette))
    })

    ## Power calc plot
    output$plot_power <- renderPlotly({
        return(plot_power(rm_data, input$selectUMC, color_palette))
    })

    ## IACUC plot
    output$plot_iacuc <- renderPlotly({
        return(plot_iacuc(rm_data, input$selectUMC, color_palette))
    })

    ## All UMC's page plots ##

    ## Open Science

    ## Open Access

    output$plot_allumc_openaccess <- renderPlotly({
        return(plot_allumc_openaccess(rm_data, color_palette))
    })

    ## Open Data

    output$plot_allumc_opendata <- renderPlotly({
        return(plot_allumc_opendata(odoc_data, color_palette, color_palette_bars))
    })

    ## Open Code

    output$plot_allumc_opencode <- renderPlotly({
        return(plot_allumc_opencode(odoc_data, color_palette, color_palette_bars))
    })

    ## Clinical Trials

    ## TRN

    output$plot_allumc_clinicaltrials_trn <- renderPlotly({
        return(plot_allumc_clinicaltrials_trn(rm_data, color_palette))
    })
    
    
}

## Create Shiny object
shinyApp(ui, server)
