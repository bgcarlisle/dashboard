library(tidyverse)
library(DBI)

### Read in the data set that has OA and TRN columns
original <- read_csv(
    "~/Downloads/rm-dash/2021-01-26_pp-dataset-oa-trn-sciscore-od.csv",
    col_types="ccdddcccccdccccdlllllcddccccDlccccccccccccccccccccddddddddddddddddddddddddlcclclcc"
)

### Generate the following CSV using the CSV above and the R script at the following address:
### https://codeberg.org/bgcarlisle/PubmedIntersectionCheck

### Use the Pubmed search string from:
### https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3104815/

animals <- read_csv("2021-01-19_13-06-59-checked-pmids-animal.csv")

### Then generate the following CSV using the same R script as above, but this time
### use the following search string:
### "clinical trial"[pt] NOT (animals [mh] NOT humans [mh])

clinical_trials <- read_csv("2021-01-19_13-03-31-checked-pmids-clinical.csv")

joined <- original %>%
    left_join(animals, by=c("pmid_dimensions" = "pmid")) %>%
    rename(is_animal = found)

joined_filename <- Sys.time() %>%
    str_replace_all(":", "-") %>%
    str_replace_all(" ", "_") %>%
    paste0("-joined.csv")

joined %>%
    write_csv(joined_filename)

### Now join with Sciscore data

con <- dbConnect(RSQLite::SQLite(), "~/Academic/2020-12-01-robustness/2019-11-17-sciscore_pmcoai_all2.db")

sciscore_reports <- con %>%
    dbReadTable("sciscore_reports")

original$pmid_dimensions <- original$pmid_dimensions %>%
    as.character

joinedwithsciscore <- original %>%
    left_join(sciscore_reports, by=c("pmid_dimensions" = "pmid"))

joinedwithsciscore_filename <- Sys.time() %>%
    str_replace_all(":", "-") %>%
    str_replace_all(" ", "_") %>%
    paste0("-joinedwithsciscore.csv")

joinedwithsciscore %>%
    write_csv(joinedwithsciscore_filename)
